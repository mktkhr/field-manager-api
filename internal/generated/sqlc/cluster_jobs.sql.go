// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: cluster_jobs.sql

package sqlc

import (
	"context"

	"github.com/google/uuid"
	"github.com/jackc/pgx/v5/pgtype"
)

const createClusterJob = `-- name: CreateClusterJob :one
INSERT INTO cluster_jobs (
    id,
    status,
    priority,
    created_at
)
VALUES ($1, 'pending', $2, NOW())
RETURNING id, status, priority, created_at, started_at, completed_at, error_message, affected_h3_cells
`

type CreateClusterJobParams struct {
	ID       uuid.UUID `json:"id"`
	Priority int32     `json:"priority"`
}

// クラスタージョブを作成
func (q *Queries) CreateClusterJob(ctx context.Context, arg *CreateClusterJobParams) (*ClusterJob, error) {
	row := q.db.QueryRow(ctx, createClusterJob, arg.ID, arg.Priority)
	var i ClusterJob
	err := row.Scan(
		&i.ID,
		&i.Status,
		&i.Priority,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.ErrorMessage,
		&i.AffectedH3Cells,
	)
	return &i, err
}

const createClusterJobWithAffectedCells = `-- name: CreateClusterJobWithAffectedCells :one
INSERT INTO cluster_jobs (
    id,
    status,
    priority,
    affected_h3_cells,
    created_at
)
VALUES ($1, 'pending', $2, $3, NOW())
RETURNING id, status, priority, created_at, started_at, completed_at, error_message, affected_h3_cells
`

type CreateClusterJobWithAffectedCellsParams struct {
	ID              uuid.UUID `json:"id"`
	Priority        int32     `json:"priority"`
	AffectedH3Cells []string  `json:"affected_h3_cells"`
}

// 影響セル情報付きでクラスタージョブを作成
func (q *Queries) CreateClusterJobWithAffectedCells(ctx context.Context, arg *CreateClusterJobWithAffectedCellsParams) (*ClusterJob, error) {
	row := q.db.QueryRow(ctx, createClusterJobWithAffectedCells, arg.ID, arg.Priority, arg.AffectedH3Cells)
	var i ClusterJob
	err := row.Scan(
		&i.ID,
		&i.Status,
		&i.Priority,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.ErrorMessage,
		&i.AffectedH3Cells,
	)
	return &i, err
}

const deleteOldCompletedJobs = `-- name: DeleteOldCompletedJobs :exec
DELETE FROM cluster_jobs
WHERE status = 'completed' AND completed_at < NOW() - INTERVAL '7 days'
`

// 7日以上前に完了したジョブを削除
func (q *Queries) DeleteOldCompletedJobs(ctx context.Context) error {
	_, err := q.db.Exec(ctx, deleteOldCompletedJobs)
	return err
}

const deleteOldFailedJobs = `-- name: DeleteOldFailedJobs :exec
DELETE FROM cluster_jobs
WHERE status = 'failed' AND completed_at < NOW() - INTERVAL '30 days'
`

// 30日以上前に失敗したジョブを削除
func (q *Queries) DeleteOldFailedJobs(ctx context.Context) error {
	_, err := q.db.Exec(ctx, deleteOldFailedJobs)
	return err
}

const getClusterJob = `-- name: GetClusterJob :one
SELECT
    id,
    status,
    priority,
    created_at,
    started_at,
    completed_at,
    error_message
FROM cluster_jobs
WHERE id = $1
`

type GetClusterJobRow struct {
	ID           uuid.UUID          `json:"id"`
	Status       string             `json:"status"`
	Priority     int32              `json:"priority"`
	CreatedAt    pgtype.Timestamptz `json:"created_at"`
	StartedAt    pgtype.Timestamptz `json:"started_at"`
	CompletedAt  pgtype.Timestamptz `json:"completed_at"`
	ErrorMessage *string            `json:"error_message"`
}

// クラスタージョブをIDで取得
func (q *Queries) GetClusterJob(ctx context.Context, id uuid.UUID) (*GetClusterJobRow, error) {
	row := q.db.QueryRow(ctx, getClusterJob, id)
	var i GetClusterJobRow
	err := row.Scan(
		&i.ID,
		&i.Status,
		&i.Priority,
		&i.CreatedAt,
		&i.StartedAt,
		&i.CompletedAt,
		&i.ErrorMessage,
	)
	return &i, err
}

const getPendingClusterJobs = `-- name: GetPendingClusterJobs :many
SELECT
    id,
    status,
    priority,
    created_at,
    started_at,
    completed_at,
    error_message
FROM cluster_jobs
WHERE status = 'pending'
ORDER BY priority DESC, created_at
LIMIT $1
FOR UPDATE SKIP LOCKED
`

type GetPendingClusterJobsRow struct {
	ID           uuid.UUID          `json:"id"`
	Status       string             `json:"status"`
	Priority     int32              `json:"priority"`
	CreatedAt    pgtype.Timestamptz `json:"created_at"`
	StartedAt    pgtype.Timestamptz `json:"started_at"`
	CompletedAt  pgtype.Timestamptz `json:"completed_at"`
	ErrorMessage *string            `json:"error_message"`
}

// 保留中のジョブを優先度順に取得(排他ロック)
func (q *Queries) GetPendingClusterJobs(ctx context.Context, limit int32) ([]*GetPendingClusterJobsRow, error) {
	rows, err := q.db.Query(ctx, getPendingClusterJobs, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*GetPendingClusterJobsRow{}
	for rows.Next() {
		var i GetPendingClusterJobsRow
		if err := rows.Scan(
			&i.ID,
			&i.Status,
			&i.Priority,
			&i.CreatedAt,
			&i.StartedAt,
			&i.CompletedAt,
			&i.ErrorMessage,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const getPendingClusterJobsWithAffectedCells = `-- name: GetPendingClusterJobsWithAffectedCells :many
SELECT
    id,
    status,
    priority,
    affected_h3_cells,
    created_at,
    started_at,
    completed_at,
    error_message
FROM cluster_jobs
WHERE status = 'pending'
ORDER BY priority DESC, created_at
LIMIT $1
FOR UPDATE SKIP LOCKED
`

type GetPendingClusterJobsWithAffectedCellsRow struct {
	ID              uuid.UUID          `json:"id"`
	Status          string             `json:"status"`
	Priority        int32              `json:"priority"`
	AffectedH3Cells []string           `json:"affected_h3_cells"`
	CreatedAt       pgtype.Timestamptz `json:"created_at"`
	StartedAt       pgtype.Timestamptz `json:"started_at"`
	CompletedAt     pgtype.Timestamptz `json:"completed_at"`
	ErrorMessage    *string            `json:"error_message"`
}

// 保留中のジョブを影響セル情報付きで優先度順に取得(排他ロック)
func (q *Queries) GetPendingClusterJobsWithAffectedCells(ctx context.Context, limit int32) ([]*GetPendingClusterJobsWithAffectedCellsRow, error) {
	rows, err := q.db.Query(ctx, getPendingClusterJobsWithAffectedCells, limit)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []*GetPendingClusterJobsWithAffectedCellsRow{}
	for rows.Next() {
		var i GetPendingClusterJobsWithAffectedCellsRow
		if err := rows.Scan(
			&i.ID,
			&i.Status,
			&i.Priority,
			&i.AffectedH3Cells,
			&i.CreatedAt,
			&i.StartedAt,
			&i.CompletedAt,
			&i.ErrorMessage,
		); err != nil {
			return nil, err
		}
		items = append(items, &i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const hasPendingOrProcessingJob = `-- name: HasPendingOrProcessingJob :one
SELECT EXISTS(
    SELECT 1 FROM cluster_jobs
    WHERE status IN ('pending', 'processing')
) AS has_job
`

// 保留中または処理中のジョブがあるか確認
func (q *Queries) HasPendingOrProcessingJob(ctx context.Context) (bool, error) {
	row := q.db.QueryRow(ctx, hasPendingOrProcessingJob)
	var has_job bool
	err := row.Scan(&has_job)
	return has_job, err
}

const updateClusterJobToCompleted = `-- name: UpdateClusterJobToCompleted :exec
UPDATE cluster_jobs
SET
    status = 'completed',
    completed_at = NOW()
WHERE id = $1
`

// ジョブを完了に更新
func (q *Queries) UpdateClusterJobToCompleted(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, updateClusterJobToCompleted, id)
	return err
}

const updateClusterJobToFailed = `-- name: UpdateClusterJobToFailed :exec
UPDATE cluster_jobs
SET
    status = 'failed',
    completed_at = NOW(),
    error_message = $2
WHERE id = $1
`

type UpdateClusterJobToFailedParams struct {
	ID           uuid.UUID `json:"id"`
	ErrorMessage *string   `json:"error_message"`
}

// ジョブを失敗に更新
func (q *Queries) UpdateClusterJobToFailed(ctx context.Context, arg *UpdateClusterJobToFailedParams) error {
	_, err := q.db.Exec(ctx, updateClusterJobToFailed, arg.ID, arg.ErrorMessage)
	return err
}

const updateClusterJobToProcessing = `-- name: UpdateClusterJobToProcessing :exec
UPDATE cluster_jobs
SET
    status = 'processing',
    started_at = NOW()
WHERE id = $1
`

// ジョブを処理中に更新
func (q *Queries) UpdateClusterJobToProcessing(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.Exec(ctx, updateClusterJobToProcessing, id)
	return err
}
